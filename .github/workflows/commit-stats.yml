name: Update Gist with Commit Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: '338403779e7b3bb02be6078db4c7d778'
        run: |
          python3 << 'EOF'
          import subprocess
          import os
          import requests
          from datetime import datetime
          
          # Get commit logs
          result = subprocess.run(
              ['git', 'log', '--format=%ai'],
              capture_output=True,
              text=True,
              cwd='.'
          )
          
          time_stats = {
              'Morning': [6, 11],
              'Daytime': [12, 17],
              'Evening': [18, 23],
              'Night': [0, 5]
          }
          
          counts = {k: 0 for k in time_stats}
          total = 0
          
          for line in result.stdout.strip().split('\n'):
              if not line:
                  continue
              parts = line.split()
              if len(parts) >= 2:
                  time_str = parts[1]  # HH:MM:SS format
                  hour = int(time_str.split(':')[0])
                  total += 1
                  
                  for period, (start, end) in time_stats.items():
                      if start <= hour <= end:
                          counts[period] += 1
                          break
          
          # Create gist content
          gist_content = '# I\'m a night ü¶â\n\n'
          emoji_map = {'Morning': 'üåû', 'Daytime': 'üåÜ', 'Evening': 'üåÉ', 'Night': 'üåô'}
          
          for period in ['Morning', 'Daytime', 'Evening', 'Night']:
              count = counts[period]
              pct = (count / total * 100) if total > 0 else 0
              emoji = emoji_map[period]
              gist_content += f'{emoji} {period:<10} {count:>4} commits {pct:>5.1f}%\n'
          
          # Update Gist
          headers = {
              'Authorization': f'token {os.environ["GIST_TOKEN"]}',
              'Accept': 'application/vnd.github+json'
          }
          
          data = {
              'files': {
                  'I\'m a night ü¶â': {
                      'content': gist_content
                  }
              }
          }
          
          url = f'https://api.github.com/gists/{os.environ["GIST_ID"]}'
          response = requests.patch(url, json=data, headers=headers)
          
          if response.status_code == 200:
              print('‚úÖ Gist updated successfully!')
          else:
              print(f'‚ùå Failed: {response.status_code}')
              print(response.text)
          EOF
