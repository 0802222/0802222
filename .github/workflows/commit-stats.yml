name: Update Commit Stats

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì •ì— ì‹¤í–‰
  workflow_dispatch:    # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Calculate commit stats
        id: stats
        run: |
          python - << 'EOF'
          import subprocess
          from datetime import datetime
          import json
          
          # Git ë¡œê·¸ì—ì„œ ì»¤ë°‹ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
          result = subprocess.run(
              ['git', 'log', '--format=%H %ai'],
              capture_output=True,
              text=True,
              cwd='.'
          )
          
          # ì‹œê°„ëŒ€ë³„ ì»¤ë°‹ ìˆ˜ ê³„ì‚°
          time_stats = {
              'Morning': {'count': 0, '06': 0, '07': 0, '08': 0, '09': 0, '10': 0, '11': 0},
              'Daytime': {'count': 0, '12': 0, '13': 0, '14': 0, '15': 0, '16': 0, '17': 0},
              'Evening': {'count': 0, '18': 0, '19': 0, '20': 0, '21': 0, '22': 0, '23': 0},
              'Night': {'count': 0, '00': 0, '01': 0, '02': 0, '03': 0, '04': 0, '05': 0}
          }
          
          total_commits = 0
          
          for line in result.stdout.strip().split('\n'):
              if not line:
                  continue
              parts = line.split()
              if len(parts) >= 2:
                  timestamp = parts[1]  # YYYY-MM-DD
                  time_part = parts[2]  # HH:MM:SS
                  hour = time_part.split(':')[0]
                  
                  total_commits += 1
                  
                  if 6 <= int(hour) <= 11:
                      time_stats['Morning']['count'] += 1
                  elif 12 <= int(hour) <= 17:
                      time_stats['Daytime']['count'] += 1
                  elif 18 <= int(hour) <= 23:
                      time_stats['Evening']['count'] += 1
                  else:  # 0-5
                      time_stats['Night']['count'] += 1
          
          # í¼ì„¼íŠ¸ ê³„ì‚°
          for period in time_stats:
              count = time_stats[period]['count']
              percentage = (count / total_commits * 100) if total_commits > 0 else 0
              print(f"{period} {count} {percentage:.1f}%")
          
          # í™˜ê²½ ë³€ìˆ˜ë¡œ ê²°ê³¼ ì „ë‹¬
          print(f"STATS={json.dumps(time_stats)}", file=open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a'))
          EOF

      - name: Update Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: '338403779e7b3bb02be6078db4c7d778'
        run: |
          python - << 'EOF'
          import subprocess
          import os
          from datetime import datetime
          
          # Git ë¡œê·¸ì—ì„œ ì»¤ë°‹ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
          result = subprocess.run(
              ['git', 'log', '--format=%ai'],
              capture_output=True,
              text=True,
              cwd='.'
          )
          
          time_stats = {
              'Morning': [6, 11],
              'Daytime': [12, 17],
              'Evening': [18, 23],
              'Night': [0, 5]
          }
          
          counts = {k: 0 for k in time_stats}
          total = 0
          
          for line in result.stdout.strip().split('\n'):
              if not line:
                  continue
              time_part = line.split()[1]  # HH:MM:SS
              hour = int(time_part.split(':')[0])
              total += 1
              
              for period, (start, end) in time_stats.items():
                  if start <= hour <= end:
                      counts[period] += 1
                      break
          
          # Gist ì½˜í…ì¸  ìƒì„±
          gist_content = '# I\'m a night ğŸ¦‰\n\n'
          for period in ['Morning', 'Daytime', 'Evening', 'Night']:
              count = counts[period]
              pct = (count / total * 100) if total > 0 else 0
              emoji = {'Morning': 'ğŸŒ', 'Daytime': 'ğŸŒ†', 'Evening': 'ğŸŒƒ', 'Night': 'ğŸŒ™'}[period]
              gist_content += f'{emoji} {period:<10} {count:>4} commits {pct:>5.1f}%\n'
          
          # Gist ì—…ë°ì´íŠ¸
          import requests
          
          headers = {
              'Authorization': f'token {os.environ.get("GIST_TOKEN")}',
              'Accept': 'application/vnd.github+json'
          }
          
          data = {
              'files': {
                  'I\'m a night ğŸ¦‰': {
                      'content': gist_content
                  }
              }
          }
          
          url = f'https://api.github.com/gists/{os.environ.get("GIST_ID")}'
          response = requests.patch(url, json=data, headers=headers)
          
          if response.status_code == 200:
              print('âœ… Gist ì—…ë°ì´íŠ¸ ì„±ê³µ!')
          else:
              print(f'âŒ ì‹¤íŒ¨: {response.status_code}')
              print(response.text)
          EOF
