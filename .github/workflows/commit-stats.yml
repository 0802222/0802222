name: Update Gist
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update Gist Stats
        run: |
          # Ïª¨ÎØ∏Ìä∏ Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞
          MORNING=0
          DAYTIME=0
          EVENING=0
          NIGHT=0
          TOTAL=0

          while IFS= read -r line; do
            HOUR=$(echo "$line" | cut -d' ' -f2 | cut -d':' -f1)
            TOTAL=$((TOTAL + 1))
            
            if [ $HOUR -ge 6 ] && [ $HOUR -lt 12 ]; then
              MORNING=$((MORNING + 1))
            elif [ $HOUR -ge 12 ] && [ $HOUR -lt 18 ]; then
              DAYTIME=$((DAYTIME + 1))
            elif [ $HOUR -ge 18 ]; then
              EVENING=$((EVENING + 1))
            else
              NIGHT=$((NIGHT + 1))
            fi
          done < <(git log --format=%ai)

          # ÎëêÍ∞êÎèÑ Í≥ÑÏÇ∞
          MORNING_PCT=$(echo "scale=1; $MORNING * 100 / $TOTAL" | bc 2>/dev/null || echo "0.0")
          DAYTIME_PCT=$(echo "scale=1; $DAYTIME * 100 / $TOTAL" | bc 2>/dev/null || echo "0.0")
          EVENING_PCT=$(echo "scale=1; $EVENING * 100 / $TOTAL" | bc 2>/dev/null || echo "0.0")
          NIGHT_PCT=$(echo "scale=1; $NIGHT * 100 / $TOTAL" | bc 2>/dev/null || echo "0.0")

          # Gist ÎÇ¥Ïö© ÎßåÎì§Í∏∞
          CONTENT="# I'm a night ü¶â

üåû Morning     $MORNING commits $MORNING_PCT%
üåÜ Daytime    $DAYTIME commits $DAYTIME_PCT%
üåÉ Evening    $EVENING commits $EVENING_PCT%
üåô Night      $NIGHT commits $NIGHT_PCT%"

          # JSON Îç∞Ïù¥ÌÑ∞ Î∞©ÏßÅ
          CONTENT_JSON=$(echo "$CONTENT" | jq -Rs .)
          
          # Gist API Ìò∏Ï∂ú
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"files\": {\"I'm a night ü¶â\": {\"content\": $CONTENT_JSON}}}" \
            https://api.github.com/gists/338403779e7b3bb02be6078db4c7d778
          
          echo "\n‚úÖ Gist updated successfully!"
