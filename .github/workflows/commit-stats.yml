name: Update Gist
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Update commit stats
        run: |
          python3 << 'ENDPYTHON'
          import json
          import subprocess
          import os
          
          # Count commits by hour
          M = D = E = N = T = 0
          result = subprocess.run(
            ['git', 'log', '--format=%ai'],
            capture_output=True, text=True
          )
          
          for line in result.stdout.strip().split('\\n'):
            if not line:
              continue
            hour = int(line.split()[1][:2])
            T += 1
            if 6 <= hour < 12:
              M += 1
            elif 12 <= hour < 18:
              D += 1
            elif 18 <= hour < 24:
              E += 1
            else:
              N += 1
          
          # Calculate percentages
          MP = M * 100 // T if T > 0 else 0
          DP = D * 100 // T if T > 0 else 0
          EP = E * 100 // T if T > 0 else 0
          NP = N * 100 // T if T > 0 else 0
          
          # Build content
          content = f"""# I'm a night ðŸ¦‰
ðŸŒž Morning {M} commits {MP}%
ðŸŒ† Daytime {D} commits {DP}%
ðŸŒƒ Evening {E} commits {EP}%
ðŸŒ™ Night {N} commits {NP}%"""
          
          # Build JSON payload
          payload = {
            "files": {
              "I'm a night ðŸ¦‰": {
                "content": content
              }
            }
          }
          
          # Send to Gist
          import urllib.request
          url = 'https://api.github.com/gists/338403779e7b3bb02be6078db4c7d778'
          token = os.environ.get('GIST_TOKEN')
          
          req = urllib.request.Request(
            url,
            data=json.dumps(payload).encode(),
            headers={
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github+json',
              'Content-Type': 'application/json'
            },
            method='PATCH'
          )
          
          try:
            with urllib.request.urlopen(req) as response:
              print(f'Success: {response.status}')
          except Exception as e:
            print(f'Error: {e}')
            raise
          ENDPYTHON
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
