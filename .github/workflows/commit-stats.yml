name: Update Gist
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Update commit stats
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: 338403779e7b3bb02be6078db4c7d778
        run: |
          M=0 D=0 E=0 N=0 T=0
          while read h; do
            ((T++))
            case $h in
              6|7|8|9|10|11) ((M++)) ;;
              12|13|14|15|16|17) ((D++)) ;;
              18|19|20|21|22|23) ((E++)) ;;
              *) ((N++)) ;;
            esac
          done < <(git log --format=%ai | awk '{print int($2)}')
          
          MP=$((M*100/T))
          DP=$((D*100/T))
          EP=$((E*100/T))
          NP=$((N*100/T))
          
          CONTENT="# I'm a night ðŸ¦‰
ðŸŒž Morning $M commits $MP%
ðŸŒ† Daytime $D commits $DP%
ðŸŒƒ Evening $E commits $EP%
ðŸŒ™ Night $N commits $NP%"
          
          curl -X PATCH \
            -H "Authorization: token $GIST_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "{\"files\": {\"I'm a night ðŸ¦‰\": {\"content\": \"$CONTENT\"}}}" \
            https://api.github.com/gists/$GIST_ID
          
          echo "Done!"
