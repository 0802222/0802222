name: Update Gist
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Update commit stats
        run: |
          #!/bin/bash
          M=0 D=0 E=0 N=0 T=0
          while read h; do
            ((T++))
            case $h in
              6|7|8|9|10|11) ((M++)) ;;
              12|13|14|15|16|17) ((D++)) ;;
              18|19|20|21|22|23) ((E++)) ;;
              *) ((N++)) ;;
            esac
          done < <(git log --format=%ai | awk '{print int($2)}')
          
          MP=$((M*100/T))
          DP=$((D*100/T))
          EP=$((E*100/T))
          NP=$((N*100/T))
          
          # Build JSON payload
          FILENAME="I'm a night ðŸ¦‰"
          CONTENT=$(cat <<'EOF'
# I'm a night ðŸ¦‰
ðŸŒž Morning $M commits $MP%
ðŸŒ† Daytime $D commits $DP%
ðŸŒƒ Evening $E commits $EP%
ðŸŒ™ Night $N commits $NP%
EOF
          )
          
          # Escape JSON properly
          CONTENT=$(echo "$CONTENT" | jq -Rs .)
          
          # Create the JSON payload
          PAYLOAD=$(jq -n --arg f "$FILENAME" --arg c "$CONTENT" '{files: {($f): {content: $c}}}')
          
          # Send to Gist API
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            https://api.github.com/gists/338403779e7b3bb02be6078db4c7d778
          
          echo "Done!"
