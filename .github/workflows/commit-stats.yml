name: Update Gist
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Update commit stats
        run: |
          python3 << 'PYEOF'
          import json
          import subprocess
          import os
          import urllib.request
          
          M = D = E = N = T = 0
          result = subprocess.run(['git', 'log', '--format=%ai'], capture_output=True, text=True)
          
          for line in result.stdout.strip().split('\n'):
            if not line:
              continue
            hour = int(line.split()[1][:2])
            T += 1
            if 6 <= hour < 12:
              M += 1
            elif 12 <= hour < 18:
              D += 1
            elif 18 <= hour < 24:
              E += 1
            else:
              N += 1
          
          MP = M * 100 // T if T > 0 else 0
          DP = D * 100 // T if T > 0 else 0
          EP = E * 100 // T if T > 0 else 0
          NP = N * 100 // T if T > 0 else 0
          
          content = '# I\'m a night ðŸ¦‰\n'
          content += 'ðŸŒž Morning ' + str(M) + ' commits ' + str(MP) + '%\n'
          content += 'ðŸŒ† Daytime ' + str(D) + ' commits ' + str(DP) + '%\n'
          content += 'ðŸŒƒ Evening ' + str(E) + ' commits ' + str(EP) + '%\n'
          content += 'ðŸŒ™ Night ' + str(N) + ' commits ' + str(NP) + '%'
          
          payload = {'files': {'I\'m a night ðŸ¦‰': {'content': content}}}
          data = json.dumps(payload).encode('utf-8')
          
          req = urllib.request.Request(
            'https://api.github.com/gists/338403779e7b3bb02be6078db4c7d778',
            data=data,
            headers={
              'Authorization': 'token ' + os.environ.get('GIST_TOKEN'),
              'Accept': 'application/vnd.github+json',
              'Content-Type': 'application/json'
            },
            method='PATCH'
          )
          
          try:
            with urllib.request.urlopen(req) as response:
              print('Status:', response.status)
          except Exception as e:
            print('Error:', e)
            raise
          PYEOF
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
